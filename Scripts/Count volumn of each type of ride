--Connect all tables & clean data
WITH A1 AS (
SELECT
  ride_id, started_at, ended_at, member_casual
FROM `Bike_data.202102_tripdata`
WHERE
  (EXTRACT(DAY FROM started_at) = EXTRACT(DAY FROM ended_at))
  AND (EXTRACT(TIME FROM ended_at) > EXTRACT(TIME FROM started_at))

UNION ALL

SELECT
  ride_id, started_at, ended_at, member_casual
FROM `Bike_data.202103_tripdata`
WHERE
  (EXTRACT(DAY FROM started_at) = EXTRACT(DAY FROM ended_at))
  AND (EXTRACT(TIME FROM ended_at) > EXTRACT(TIME FROM started_at))

UNION ALL

SELECT
  ride_id, started_at, ended_at, member_casual
FROM `Bike_data.202104_tripdata`
WHERE
  (EXTRACT(DAY FROM started_at) = EXTRACT(DAY FROM ended_at))
  AND (EXTRACT(TIME FROM ended_at) > EXTRACT(TIME FROM started_at))

UNION ALL

SELECT
  ride_id, started_at, ended_at, member_casual
FROM `Bike_data.202105_tripdata`
WHERE
  (EXTRACT(DAY FROM started_at) = EXTRACT(DAY FROM ended_at))
  AND (EXTRACT(TIME FROM ended_at) > EXTRACT(TIME FROM started_at))
),
--Calculation Ride length
B1 AS (
SELECT 
  ride_id,
  member_casual,
  started_at,
  ended_at,
  (EXTRACT(HOUR FROM ended_at) - EXTRACT(HOUR FROM started_at))*60 + (EXTRACT(MINUTE FROM ended_at) - EXTRACT(MINUTE FROM started_at)) AS Ride_length
FROM A1
),
--Classify based on Ride length
B2 AS (
SELECT
  *,
  CASE
    WHEN Ride_length < 30 THEN '<30'
    WHEN Ride_length > 30 AND Ride_length <= 60 THEN '30-60'
    ELSE '>1hours' END AS classification,
FROM B1
),
--Count for membership rides
C1 AS (
SELECT
  classification,
  COUNT(ride_id) AS Member
FROM B2
GROUP BY classification, Member_casual
HAVING Member_casual = 'member'
),
--Count for casual rides
C2 AS (
SELECT
  classification,
  COUNT(ride_id) AS Casual
FROM B2
GROUP BY classification, Member_casual
HAVING Member_casual = 'casual'
)
SELECT
  C1.classification,
  C1.Member,
  C2.Casual
FROM C1
LEFT JOIN C2 ON C1.classification = C2.classification
-- The calculation reveals that the number of <30 minutes" membership rides is significantly higher that of casual, which also is constrast to contrast to 2 other categories, despite having fewer membership than casual accounts
-- This support the hypothesis that people who ride to commute is more likely to buy subsription
